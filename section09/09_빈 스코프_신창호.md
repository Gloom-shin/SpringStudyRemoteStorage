
# ìŠ¤í”„ë§ì˜ ê°•ì˜ ë¦¬ë·°ğŸ“½
> LoadMap Part : ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ - ê¸°ë³¸í¸   
> Section : 09.ë¹ˆ ìŠ¤ì½”í”„  
> CreateDate : 2022.06.22  
> UpdateDate : 2022.06

### ëª©ì°¨

- [ë¹ˆ ìŠ¤ì½”í”„ë€?](#beanScope)
- [í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„](#prototype)
    - [ì‹±ê¸€í†¤ ë¹ˆê³¼ í•¨ê»˜ ì‚¬ìš©ì‹œ ë¬¸ì œì ](#problem)
    - Providerë¡œ ë¬¸ì œ í•´ê²°
- ì›¹ ìŠ¤ì½”í”„
- Request ìŠ¤ì½”í”„ ì˜ˆì œ ë§Œë“¤ê¸°
- ìŠ¤ì½”í”„ì™€ Provider
- ìŠ¤ì½”í”„ì™€ í”„ë¡ì‹œ
  <br></br>
  <br></br>

# 1. ë¹ˆ ìŠ¤ì½”í”„(Bean Scope)ë€?<a name="beanScope"></a>
- ëœ» ê·¸ëŒ€ë¡œ Beanì˜ ë²”ìœ„ë¥¼ ë§í•˜ëŠ”ë°,
- ë¹ˆì˜ ë²”ìœ„ë€?
    - ìŠ¤í”„ë§ ë¹ˆì´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì˜ ì‹œì‘ê³¼ í•¨ê»˜ ìƒì„±ë˜ì–´ì„œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ë¹ˆì´ ì¡´ì¬í•  ìˆ˜ ìˆëŠ” ë²”ìœ„ë¥¼ ëœ»í•œë‹¤.

### ìŠ¤ì½”í”„ ì¢…ë¥˜
ìŠ¤í”„ë§ì€ ë‹¤ìŒê³¼ ê°™ì€ ë‹¤ì–‘í•œ ìŠ¤ì½”í”„ë¥¼ ì§€ì›í•œë‹¤.
- ì‹±ê¸€í†¤ : ìŠ¤í”„ë§ ë¹ˆì„ ìƒì„±í•˜ë©´ ì ìš©ë˜ëŠ” ê¸°ë³¸ì ì¸ ìŠ¤ì½”í”„ì´ë©°, ì»¨í…Œì´ë„ˆì˜ ì‹œì‘ê³¼ ì¢…ë£Œê¹Œì§€ ìœ ì§€ë˜ëŠ” ê°€ì¥ ë„“ì€ ë²”ìœ„ì˜ ìŠ¤ì½”í”„ì´ë‹¤.
- í”„ë¡œí† íƒ€ì… : ì´ë¦„ì—ì„œë¶€í„° ëŠê»´ì§€ë“¯ì´, ë¹ˆì˜ ìƒì„±ê³¼ ì˜ì¡´ê´€ê³„ ì£¼ì…ê¹Œì§€ë§Œ ê´€ì—¬í•˜ê³  ë”ëŠ” ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ë§¤ìš° ì§§ì€ ë²”ìœ„ì˜ ìŠ¤ì½”í”„
- ì›¹ê´€ë ¨ ìŠ¤ì½”í”„
    - request : ì›¹ ìš”ì²­ì´ ë“¤ì–´ì˜¤ê³  ë‚˜ê°ˆë•Œ ê¹Œì§€ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„
    - session : ì›¹ ì„¸ì…˜ì´ ìƒì„±ë˜ê³  ì¢…ë£Œë  ë•Œ ê¹Œì§€ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„
    - application : ì›¹ì˜ ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ì™€ ê°™ì€ ë²”ìœ„ë¡œ ìœ ì§€ë˜ëŠ” ìŠ¤ì½”í”„

### ì‚¬ìš© ë°©ë²•
- ìë™ ë“±ë¡
    - @Component ìœ„ì— ì¶”ê°€í•˜ë©´, ìŠ¤ìº”í•  ë•Œ ë“±ë¡ëœë‹¤.
 ```java
@Scope("prototype")
@Component
public class HelloBean {}
```
- ìˆ˜ë™ ë“±ë¡
    - @Bean ìœ„ì— ì¶”ê°€í•˜ë©´, ë¹ˆì´ ë“±ë¡ë  ë•Œ ê°™ì´ ëœë‹¤.
 ```java
@Scope("prototype")
@Bean
PrototypeBean HelloBean() {
 return new HelloBean();
}
```
<br></br>
<br></br>

# í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„<a name="prototype"></a>
- í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ë¥¼ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ì¡°íšŒí•˜ë©´ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” í•­ìƒ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ì„œ ë°˜í™˜í•œë‹¤

## íë¦„
### ì‹±ê¸€í†¤ ë¹ˆ ìš”ì²­
1. ì‹±ê¸€í†¤ ìŠ¤ì½”í”„ì˜ ë¹ˆì„ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìš”ì²­í•œë‹¤.
2. ì»¨í…Œì´ë„ˆëŠ” ë³¸ì¸ì´ ê´€ë¦¬í•˜ëŠ” ìŠ¤í”„ë§ ë¹ˆì„ ë°˜í™˜í•œë‹¤
3. ì´í›„ì— ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ê°™ì€ ìš”ì²­ì´ ì™€ë„ ê°™ì€ ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì˜ ìŠ¤í”„ë§ ë¹ˆì„ ë°˜í™˜í•œë‹¤.

### í”„ë¡œí† íƒ€ì… ë¹ˆ ìš”ì²­
1. í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ì˜ ë¹ˆì„ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìš”ì²­í•œë‹¤.
2. ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” ì´ ì‹œì ì— í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìƒì„±í•˜ê³ , í•„ìš”í•œ ì˜ì¡´ê´€ê³„ë¥¼ ì£¼ì…í•œë‹¤.
3. ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” ìƒì„±í•œ í”„ë¡œí† íƒ€ì… ë¹ˆì„ í´ë¼ì´ì–¸íŠ¸ì— ë°˜í™˜í•œë‹¤.
4. ì´í›„ì— ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ê°™ì€ ìš”ì²­ì´ ì˜¤ë©´ í•­ìƒ ìƒˆë¡œìš´ í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìƒì„±í•´ì„œ ë°˜í™˜í•œë‹¤.

<img src="https://user-images.githubusercontent.com/104331549/175200976-b424f35b-8b73-4f4b-a2a4-0f4844d53a7b.png">

```java
public class PrototypeTest {
    @Test
    public void singletonBeanFind(){
        AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext(PrototypeBean.class);
        PrototypeBean prototypeBean1 = ac.getBean(PrototypeBean.class);
        PrototypeBean prototypeBean2 = ac.getBean(PrototypeBean.class);
        System.out.println("prototypeBean1 = " + prototypeBean1);
        System.out.println("prototypeBean2 = " + prototypeBean2);
        Assertions.assertThat(prototypeBean1).isNotSameAs(prototypeBean2);

        ac.close();
    }

    @Scope("prototype")
    static class PrototypeBean{
        @PostConstruct
        public void init(){
            System.out.println("SingletonBean.init");
        }


        @PreDestroy  // ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
        public void close(){
            System.out.println("SingletonBean.close");
        }
    }

}
```

#### ì‹¤í–‰ê²°ê³¼
```java
PrototypeBean.init
PrototypeBean.init
prototypeBean1 = hello.core.scope.PrototypeTest$PrototypeBean@30e868be
prototypeBean2 = hello.core.scope.PrototypeTest$PrototypeBean@66c92293
org.springframework.context.annotation.AnnotationConfigApplicationContext - 
Closing //org.springframework.context.annotation.AnnotationConfigApplicationContext@47d9a273, started on Thu Jun 23 11:15:20 KST 2022
```
- í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ì˜ ë¹ˆì€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ì„œ ë¹ˆì„ ì¡°íšŒí•  ë•Œ ìƒì„±ë˜ê³ , ì´ˆê¸°í™” ë©”ì„œë“œë„ ì‹¤í–‰ëœë‹¤.
- í”„ë¡œí† íƒ€ì… ë¹ˆì„ 2ë²ˆ ì¡°íšŒí–ˆìœ¼ë¯€ë¡œ ì™„ì „íˆ ë‹¤ë¥¸ ìŠ¤í”„ë§ ë¹ˆì´ ìƒì„±ë˜ê³ , ì´ˆê¸°í™”ë„ 2ë²ˆ ì‹¤í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤
- í”„ë¡œí† íƒ€ì… ë¹ˆì€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ê³¼ ì˜ì¡´ê´€ê³„ ì£¼ì… ê·¸ë¦¬ê³  ì´ˆê¸°í™” ê¹Œì§€ë§Œ ê´€ì—¬í•˜ê³ , ë”ëŠ” ê´€ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ í”„ë¡œí† íƒ€ì… ë¹ˆì€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë  ë•Œ `@PreDestroy` ê°™ì€ ì¢…ë£Œ ë©”ì„œë“œê°€ ì „í˜€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤

### ì •ë¦¬ 
- ìŠ¤í”„ë§ì»¨í…Œì´ë„ˆì— ìš”ì²­í•  ë•Œ ë§ˆë‹¤ ìƒì„±ëœë‹¤. 
- ìŠ¤í”„ë§ì»¨í…Œì´ë„ˆëŠ” í”„ë¡œí† íƒ€ì… ë¹ˆì˜ ìƒì„±ê³¼ ì˜ì¡´ê´€ê³„ ì£¼ì… ê·¸ë¦¬ê³  ì´ˆê¸°í™”ê¹Œì§€ë§Œ ê´€ì—¬í•œë‹¤.
- ì¢…ë£Œ ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤. 
- ê·¸ë˜ì„œ í”„ë¡œí† íƒ€ì… ë¹ˆì„ ì¡°íšŒí•œ **í´ë¼ì´ì–¸íŠ¸ê°€ í”„ë¡œí† íƒ€ì… ë¹ˆì„ ê´€ë¦¬**í•´ì•¼ í•œë‹¤. 

> ì´ë ‡ê²Œ ë³´ë©´ ì‰¬ìš´ë°, ì‹±ê¸€í†¤ê³¼ í”„ë¡œí† íƒ€ì…ì„ ê°™ì´ ì‚¬ìš©í•  ë•Œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.
<br></br>
<br></br>
## ì‹±ê¸€í†¤ ë¹ˆê³¼ í•¨ê»˜ ì‚¬ìš©ì‹œ ë¬¸ì œì  <a name="problem"></a>
> ì‹±ê¸€í†¤ ë¹ˆê³¼ í”„ë¡œí† íƒ€ì… ë¹ˆì„ í•¨ê»˜ ì‚¬ìš©í•  ë•ŒëŠ” ì˜ë„í•œ ëŒ€ë¡œ ì˜ ë™ì‘í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•œë‹¤.

 - SingletonWithPrototypeTest1.class 
    - í…ŒìŠ¤íŠ¸ í•´ë³´ëŠ” í´ë˜ìŠ¤
```java
public class SingletonWithPrototypeTest1 {
    @Test
    void singletonClientUsePrototype(){
        AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext(ClientBean.class, PrototypeBean.class);
        ClientBean clientBean1 = ac.getBean(ClientBean.class);
        int count1 = clientBean1.logic();
        assertThat(count1).isEqualTo(1);
        ClientBean clientBean2 = ac.getBean(ClientBean.class);
        int count2 = clientBean2.logic();
        assertThat(count2).isEqualTo(2);
    }
}
```
 - ClientBean.class 
   - ì‹±ê¸€í†¤ í´ë˜ìŠ¤ 
```java
public class ClientBean {
    private final PrototypeBean prototypeBean;

    @Autowired
    public ClientBean(PrototypeBean prototypeBean) {
        this.prototypeBean = prototypeBean;
    }
    public int logic() {
        prototypeBean.addCount();
        int count = prototypeBean.getCount();
        return count;
    }
}
```

- PrototypeBean.class
  - í”„ë¡œí† íƒ€ì… í´ë˜ìŠ¤
```java
@Scope("prototype")
public class PrototypeBean {

    private int count = 0;

    public void addCount(){
        count++;
    }

    public int getCount(){
        return count;
    }

    @PostConstruct
    public void init(){
        System.out.println("PrototypeBean.init");
    }


    @PreDestroy
    public void close(){
        System.out.println("PrototypeBean.close");
    }
}

```

 - í•˜ì§€ë§Œ ì´ëŒ€ë¡œë¼ë©´, ì œëŒ€ë¡œ ì•ˆë¨
 - í”„ë¡œí† íƒ€ì… ìƒì„±ì ë¹ˆì´ í•˜ë‚˜ë§Œ ìƒì„±ëœë‹¤. 



- ìˆ˜ì •ëœ ClientBean.class
  - `logic()`ë©”ì†Œë“œê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤, í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìƒì„±í•´ì¤˜ì•¼í•œë‹¤. 
```java
public class ClientBean {
  // private final PrototypeBean prototypeBean;
  @Autowired
  ApplicationContext applicationContext;

  // @Autowired
  // public ClientBean(PrototypeBean prototypeBean) {
  //    this.prototypeBean = prototypeBean;
  // }
  public int logic() {
    PrototypeBean prototypeBean = applicationContext.getBean(PrototypeBean.class);
    prototypeBean.addCount();
    int count = prototypeBean.getCount();
    return count;
  }
}
```


## ëŠë‚€ì  ğŸ˜Œ

### ì°¸ê³  ë§í¬

